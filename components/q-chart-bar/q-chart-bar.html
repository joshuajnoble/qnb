<link rel="import" href="/bower_components/polymer/polymer.html">
<script src="/bower_components/d3/d3.min.js"></script>

<polymer-element name="q-chart-bar" extends="q-chart" attributes="url label">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        margin-left: -5rem;
        position: relative;
      }

      .axis .domain {
        stroke: none;
      }

      .axis.y text {
        font-family: "Georgia", serif;
        fill: #888;
      }

      .axis.y .label {
        font-size: 1.3rem;
      }

      .axis.y .tick text {
        text-anchor: end;
        font-size: 1.2rem;
        font-weight: bold;
        font-style: italic;
      }

      .axis.x text {
        font-family: "BentonSansExtraCondensed", "Helvetica", "Arial", sans-serif;
        font-size: 1.4rem;
        letter-spacing: .05em;
        font-weight: 500;
        fill: #333;
      }

      .axis.y .tick line {
        stroke-dasharray: 2,2;
        stroke: #ccc;
      }

      .axis.x .tick line {
        stroke: none;
      }

      .axis path,
      .axis line {
        fill: none;
        shape-rendering: crispEdges;
      }

      *[class*=data-] {
        mix-blend-mode: multiply;
      }
    </style>
    <svg id="chart"></svg>
  </template>
  <script>
    (function () {

      Polymer('q-chart-bar', {
        label:null,
        init: function () {
          var self = this;

          this.margin = {top: 3*this.rem, right: 0, bottom: 2.5*this.rem, left: 5*this.rem};
          this.width = this.clientWidth - this.margin.left - this.margin.right;
          this.height = this.clientHeight - this.margin.top - this.margin.bottom;

          this.x = d3.scale.ordinal()
              .domain(_.map(self.data.data, function(d) { return d.year; }))
              .rangeRoundBands([0, self.width], .3, 0);

          this.y = d3.scale.linear()
              .domain([0, d3.max(self.data.data, function(d) { return d.value; })*1.2])
              .range([self.height, 0]);

          this.xAxis = d3.svg.axis()
              .scale(self.x)
              .tickSize(0)
              .tickPadding(self.rem)
              .orient("bottom");

          this.yAxis = d3.svg.axis()
              .scale(self.y)
              .ticks(Math.round(self.height / self.rem / 4))
              .tickSize(self.width)
              .orient("right");

        },
        initChart: function() {
          var self = this;

          this.g = d3.select(this.$.chart)
              .attr("width", this.width + this.margin.left + this.margin.right)
              .attr("height", this.height + this.margin.top + this.margin.bottom)
            .append("g")
              .attr("transform", "translate(" + this.margin.left + "," + this.margin.top + ")");

          //draw x axis
          this.g.append("g")
              .attr("class", "x axis")
              .attr("transform", "translate(0," + this.height + ")")
              .call(self.xAxis);

          //draw y axis
          var gy = this.g.append("g")
              .attr("class", "y axis")
              .call(self.yAxis);

          gy.append("text")
              .classed("label", true)
              .attr("y", 0)
              .attr("x", 0)
              .text(self.yAxisLabel);

          gy.select(".tick").selectAll("*")
              .attr("transform", "translate(0, -" + self.rem/10 + ")");

          gy.selectAll(".tick line")
              .style("stroke-width", self.rem/10);

          gy.selectAll(".tick").selectAll("text")
              .attr("x", -self.rem)
              .style("text-anchor", "end");

        },
        drawData: function() {
          var self = this;

          this.g.selectAll(".data-bar")
              .data(self.data.data)
            .enter().append("rect")
              .classed("data-bar", true)
              .attr("x", function(d) { return self.x(d.year); })
              .attr("width", self.x.rangeBand())
              .attr("y", function(d) { return self.height; })
              .attr("height", 0)
              .attr("fill", self.colors(0))
              .transition()
              .duration(300)
              .delay(function(d, i) { return i * 300; })
              .attr("height", function(d) { return self.height - self.y(d.value); })
              .attr("y", function(d) { return self.y(d.value); });
        },
        render: function () {
          var self = this;

          this.chart.selectAll("*")
              .remove();

          this.init();
          this.initChart();
          this.drawData();
        }
      });

    })();
  </script>
</polymer-element>