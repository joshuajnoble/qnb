<!doctype html>
<html>
<head>
  <title>Quartz</title>
  <!-- Load the platform first -->
  <script src="/bower_components/platform/platform.js"></script>
  <!-- imports -->
  <link rel="import" href="/imports.html">
  <style>
    html, body {
      height: 100%;
      width: 100%;
    }

    frog-deck {
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body unresolved>

  <frog-deck id="deck" transition="fade">

    <frog-card>
      <q-view url="/data/stories/story-2.json">
        <q-visualization full title="Ring Chart" hasContent>
          <q-chart-ring url="/data/religiousness.json"></q-chart-ring>
        </q-visualization>
      </q-view>
    </frog-card>

    <frog-card>
      <q-view url="/data/stories/story-2.json">
        <q-visualization full title="Multi-line Chart" hasContent>
          <q-chart-line url="/data/face_scans_day.json"></q-chart-line>
        </q-visualization>
      </q-view>
    </frog-card>

    <frog-card>
      <q-view url="/data/stories/story-2.json">
        <q-visualization full title="World Map of Awfulness" hasContent>
          <q-chart-globe url="/data/deforestation.json" dataTopLevel="Continent"></q-chart-globe>
        </q-visualization>
      </q-view>
    </frog-card>

  </frog-deck>

  <script>
    var timer;
    var deck = document.querySelector('#deck');
    var cards = deck.querySelectorAll('frog-card');

    deck.addEventListener('change', function (e) {
      var detail = e.detail;
      if (detail.oldVal) deselectVisualizations(cards[detail.oldVal]);
      selectVisualizations(cards[detail.newVal]);
    });

    document.addEventListener('click', next, false);

    function selectVisualizations(card) {
      var visualizations = card.querySelectorAll('q-visualization > *');
      visualizations.array().forEach(function (v) {
        var cb = function () {
          if (!v.isRendered) v.render();
          if (v.start) v.start();
        };
        //console.log(v.render);
        if (v.data && v.render) {
          cb();
        } else {
          v.addEventListener('load', cb);
        }
      });
    };

    function deselectVisualizations(card) {
      var visualizations = card.querySelectorAll('q-visualization > *');
      visualizations.array().forEach(function (v) {
        if (v.stop) v.stop();
      });
    }

    function next() {
      deck.selected = (deck.selected + 1) % deck.children.length;
    };

    function start() {
      timer = window.setInterval(next, 5000);
    };

    function stop() {
      window.clearInterval(timer);
    };

    function toggle() {
      if (!timer) {
        start();
      } else {
        stop();
      }
    };

    // initial render
    window.addEventListener('WebComponentsReady', function(e) {
      selectVisualizations(cards[0]);
    });

  </script>
  
</body>
</html>